## Claude Code 逆向工程研究速览

这是一个由 ShareAI-Lab 团队（在 X 上关注我们：[https://x.com/baicai003](https://x.com/baicai003)）创建的**非官方、非 100% 准确**的 Claude Code v1.0.33 逆向工程研究仓库。该项目是在研究 Agent 模型公司如何进行 Agent 工程时，通过 Claude Code 自行分析其混淆代码而得。由于混淆代码的复杂性，分析结果可能存在一些“幻觉”，因此仅供参考和学习。相关提示词可在 `work_doc_for_this` 文件夹中找到，欢迎尝试复现。

### 最新通知

* 开源复现版将发布在：[https://github.com/shareAI-lab/AgentKode](https://github.com/shareAI-lab/AgentKode)
* 相关解析文章已在 ShareAI lab 官方公众号上二次核对并发布。

---

### **📋 项目核心目标与内容**

该仓库深入分析了 Claude Code v1.0.33 的混淆源代码，旨在揭示其核心架构、实现机制和运行逻辑。项目分析了超过 **50,000 行混淆代码**，涵盖从 UI 到 Agent 核心引擎的整个技术栈。

**研究目标：**

1.  **深度理解** Claude Code 的系统架构和核心机制。
2.  **完整还原** 混淆代码背后的技术实现逻辑。
3.  **严格验证** 分析结果的准确性和一致性。
4.  **开源重建** 提供可复现的技术实现指南。
5.  **知识共享** 为 AI Agent 系统设计提供参考。

---

### **🔬 核心技术发现与突破**

项目揭示了 Claude Code 的多项创新技术：

* **实时 Steering 机制：** 基于 **h2A 双重缓冲异步消息队列**，实现零延迟消息传递（吞吐量 > 10,000 消息/秒），采用 Promise-based 异步迭代器和智能背压控制，实现真正的非阻塞异步处理和实时流式响应。
* **分层多 Agent 架构：**
    * **主 Agent (nO)：** 核心循环引擎，负责任务调度。
    * **SubAgent (I2A)：** 子任务代理，提供隔离执行环境。
    * **Task Agent：** 专用任务处理器，支持并发执行。
    * 每个 Agent 都有独立的权限和资源访问控制。
* **智能上下文管理：**
    * **wU2 压缩器：** 在 Token 使用量达到 **92% 阈值**时自动触发上下文压缩，智能保留关键信息。
    * 通过 **CLAUDE.md** 文件进行长期记忆存储，并根据 Token 使用动态调整上下文大小。
* **强化安全防护：**
    * **6 层权限验证：** 从 UI 到工具执行的完整安全链。
    * **沙箱隔离：** 工具执行环境完全隔离。
    * 多层次的恶意输入检测和过滤，以及细粒度功能权限控制。

---

### **🏗️ 系统架构全景**

Claude Code Agent 系统的架构分为四个主要层次：

1.  **用户交互层：** 包含 CLI 接口、VSCode 集成和 Web 界面。
2.  **Agent 核心调度层：** **nO 主循环引擎**（AgentLoop）负责任务调度、状态管理和异常处理，通过 **h2A 消息队列**（AsyncQueue）进行异步通信、流式处理和背压控制。此外，还有 **wu 会话流生成器**（StreamGen）用于实时响应和流式输出，以及 **wU2 消息压缩器**（Compressor）用于智能压缩和上下文优化。
3.  **工具执行与管理层：** 包含 **MH1 工具引擎**（ToolEngine）、**UH1 并发控制**（Scheduler）、**SubAgent 管理**（TaskAgent）和**权限验证网关**（PermissionGW）。该层管理文件操作、搜索发现、任务管理、系统执行、网络交互、特殊功能、MCP 集成和开发者工具等工具生态系统。
4.  **存储与持久化层：** 包含短期记忆存储（Messages）、中期压缩历史（Compressed）、长期持久存储（CLAUDE.md）和状态缓存系统（StateCache）。

---

### **📁 仓库结构与核心文档**

仓库主要分为：

* `claude_code_v_1.0.33/`：v1.0.33 版本的完整分析工作区，包含代码分块、分析结果、脚本工具和详细文档。
* `work_doc_for_this/`：项目工作文档，包含逆向工程标准作业程序 (SOP)。

**核心技术文档涵盖：** 实时 Steering 机制、Edit 工具强制读取机制、分层多 Agent 架构、Plan 模式机制、沙箱安全机制、MCP 协议集成等。还包含验证与交叉分析报告（最终准确性达 **95%**）和开源重建指南。

---

### **🛠️ 分析方法论**

研究分为两个阶段：

1.  **静态代码分析：**
    * **代码预处理：** 美化、智能分块（102 个块）并生成索引。
    * **LLM 辅助分析：** 使用 GPT-4 进行模式识别、函数解析、依赖映射和 API 追踪。
    * **交叉验证：** 多轮迭代分析、一致性检查和源码对照（每个技术断言都有源码支持）。
2.  **动态行为验证：**
    * **运行时分析：** 追踪函数调用、监控状态变化和收集性能指标。
    * **集成测试：** 验证组件交互、边界条件和错误恢复机制。

---

### **🔍 详细研究范围与统计**

项目已分析的核心组件包括：

* **Agent 循环系统：** nO 主循环引擎（异步 Generator 实现）和消息处理管道。
* **工具执行框架：** 6 阶段执行管道（工具发现、参数/权限验证、资源分配、并发执行、结果收集），支持最大 10 并发和错误隔离。
* **内存与上下文管理：** 智能压缩算法（92% 阈值触发）、Token 优化、分层存储。
* **安全防护框架：** 6 层权限验证、沙箱隔离、恶意输入检测。
* **用户界面集成：** React 组件系统、WebSocket 实时更新和事件处理。

**验证结果统计显示：** 核心架构设计准确性 95%，关键机制实现 98%，API 调用链路 92%，安全机制 90%。

---

### **🎯 应用场景与价值**

本研究具有重要的教育、系统设计和安全分析价值，并为开源开发提供指导：

* **教育研究：** 学习 AI Agent 架构、异步编程、安全架构和性能优化。
* **系统设计参考：** 借鉴分层架构、插件化工具系统、分布式状态管理和错误处理策略。
* **安全分析应用：** 审计安全机制、研究沙箱技术、输入验证和权限控制。
* **开源开发指导：** 提供项目架构搭建、核心组件实现、测试策略和性能优化的指导。

---

### **🤝 贡献指南与免责声明**

欢迎通过改进准确性、深度分析、新发现补充、文档完善和代码实现来贡献。所有技术断言必须有源码支持，新增分析需经交叉验证。

**免责声明：** 本仓库仅用于教育和学术研究，所有分析基于公开混淆代码，不涉及恶意逆向工程，研究成果仅供学术交流和技术学习，不建议用于商业竞争目的。

---

本项目采用 **Apache License Version 2.0** 许可证开源。

**最后更新：** 2025 年 6 月 29 日  
**项目灵感来源：** [claude-code-reverse](https://github.com/Yuyz0112/claude-code-reverse)  
**维护团队：** ShareAI-Lab